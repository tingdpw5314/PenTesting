#include "arp.h"
void print_packet(struct arp_packet ap)
{
    printf("\n-----------------arp package begin--------------------------\n");
    int i ;
    printf(" mac_target = ");
    for( i = 0; i < ETH_ALEN; i++)
        printf(i > 0 ? ":0x%.2x" : "0x%.2x", ap.mac_target[i]);
    printf("\n mac_source = ");
    for( i = 0; i < ETH_ALEN; i++)
        printf(i > 0 ? ":0x%.2x" : "0x%.2x", ap.mac_source[i]);
    printf("\n ethertype = 0x%x", ntohs(ap.ethertype));
    printf("\n hw_type = 0x%x", ntohs(ap.hw_type));
    printf("\n proto_type = 0x%x", ntohs(ap.proto_type));
    printf("\n mac_addr_len = 0x%x", ap.mac_addr_len);
    printf("\n ip_addr_len = 0x%x", ap.ip_addr_len);
    printf("\n operation_code = 0x%x", ntohs(ap.operation_code));
    printf("\n mac_sender = ");
    for(i = 0; i < ETH_ALEN; i++)
        printf(i > 0 ? ":0x%.2x" : "0x%.2x", ap.mac_sender[i]);
    printf("\n ip_sender = %s", inet_ntoa(*(struct in_addr*)(ap.ip_sender)));
    printf("\n mac_receiver = ");
    for( i = 0; i < ETH_ALEN; i++)
        printf(i > 0 ? ":0x%.2x" : "0x%.2x", ap.mac_receiver[i]);
    printf("\n ip_receiver = %s", inet_ntoa(*(struct in_addr*)(ap.ip_receiver)));

    printf("\n-----------------arp package end----------------------------\n");
}


int main()
{
    int sfd;
    struct sockaddr_ll my_etheraddr;
    struct arp_packet rcvbuff;
    //socket: only catch ARP packets
    sfd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ARP));
    if(-1 == sfd)
    {
        Debug_printf("socket error");
    }

    memset(&my_etheraddr, 0, sizeof(my_etheraddr));
    my_etheraddr.sll_family = PF_PACKET;
    my_etheraddr.sll_protocol = htons(ETH_P_ARP);
    my_etheraddr.sll_ifindex = IFF_BROADCAST;

    //bind
    if(-1 == bind(sfd, (struct sockaddr *)&my_etheraddr, sizeof(my_etheraddr))){
        Debug_printf("bind error");
    }

    while(1)
    {
        //recv
        if(-1 == recv(sfd, &rcvbuff, sizeof(rcvbuff), 0)){
            Debug_printf("recv error");
            continue;
        }

        print_packet(rcvbuff);
    }

    return 0;
}

